<!DOCTYPE html>
<html lang="zh-hans">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#ede9e3">
	<meta name="msapplication-TileColor" content="#ede9e3">
<meta itemprop="name" content="Etcd入门到实践">
<meta itemprop="description" content="一、Etcd 简介 etcd 是一个强一致性的分布式键值对存储，设计用来可靠而快速的保存关键数据并提供访问。通过分布式锁，leader 选举和写屏障 (write barriers) 来">
<meta itemprop="datePublished" content="2022-04-09T11:26:27&#43;08:00" />
<meta itemprop="dateModified" content="2022-04-09T11:26:27&#43;08:00" />
<meta itemprop="wordCount" content="7583">



<meta itemprop="keywords" content="云原生," /><meta property="og:title" content="Etcd入门到实践" />
<meta property="og:description" content="一、Etcd 简介 etcd 是一个强一致性的分布式键值对存储，设计用来可靠而快速的保存关键数据并提供访问。通过分布式锁，leader 选举和写屏障 (write barriers) 来" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://whocanfly.gitee.io/posts/etcd%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/" />
<meta property="article:published_time" content="2022-04-09T11:26:27+08:00" />
<meta property="article:modified_time" content="2022-04-09T11:26:27+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Etcd入门到实践"/>
<meta name="twitter:description" content="一、Etcd 简介 etcd 是一个强一致性的分布式键值对存储，设计用来可靠而快速的保存关键数据并提供访问。通过分布式锁，leader 选举和写屏障 (write barriers) 来"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Etcd入门到实践</title>
	<link rel="stylesheet" href="https://whocanfly.gitee.io/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css" integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://whocanfly.gitee.io"> 无意 </a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://whocanfly.gitee.io/posts/"> 文章 </a>
				<a href="https://whocanfly.gitee.io/tags/"> 标签 </a>
				<a href="https://whocanfly.gitee.io/about/"> 关于 </a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://github.com/WeCanRun" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://whocanfly.gitee.io/posts/"> 文章 </a></li>
			<li><a href="https://whocanfly.gitee.io/tags/"> 标签 </a></li>
			<li><a href="https://whocanfly.gitee.io/about/"> 关于 </a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Apr 9, 2022</span></div>
				<h1>Etcd入门到实践</h1>
			</header>
			<div class="content">
				<p><img src="https://i.loli.net/2021/03/25/k3bIZ94PwCUYijD.jpg" alt="https//ilolinet/2021/03/25/k3bIZ94PwCUYijDjpg"></p>
<h2 id="一etcd-简介">一、Etcd 简介<a href="#一etcd-简介" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<blockquote>
<p>etcd 是一个强一致性的分布式键值对存储，设计用来可靠而快速的保存关键数据并提供访问。通过分布式锁，leader 选举和写屏障 (write barriers) 来实现可靠的分布式协作。etcd 集群是为高可用，持久性数据存储和检索而准备的。</p>
<p>etcd 的场景默认处理的数据都是系统中的控制数据。所以 etcd 在系统中的角色不是其他 NoSQL 产品的替代品，更不能作为应用的主要数据存储。etcd 中应该尽量只存储系统中服务的配置信息，以此来实现 <strong>服务发现</strong>、<strong>分布式通知和协调</strong>，常见的还会使用 etcd 进行 <strong>主备选举</strong>、<strong>分布式锁</strong>、<strong>分布式数据队列</strong> 以及 <strong>服务健康监控</strong>。对于应用数据只推荐把数据量很小，但是更新和访问频次都很高的数据存储在 etcd 中。官方数据显示，etcd 单实例的写操作性能在 w 级别，读操作在 10w 级别</p>
</blockquote>
<h2 id="二etcd-工作原理">二、Etcd 工作原理<a href="#二etcd-工作原理" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="1核心组件">1、核心组件<a href="#1核心组件" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p><img src="https://i.loli.net/2021/03/23/QdSj6TnVAZtHEu4.png" alt="https//ilolinet/2021/03/23/QdSj6TnVAZtHEu4png"></p>
<p>Server：用于处理用户发送的 API 请求以及其它 <code>etcd</code> 节点的同步与心跳信息请求。</p>
<p>KV Store：用于处理 <code>etcd</code> 支持的各类功能的事务，包括数据索引、节点状态变更、监控与反馈、事件处理与执行等等，是 <code>etcd</code> 对用户提供的大多数 API 功能的具体实现，底层默认使用的是开源的嵌入式键值存储数据库 <a href="https://github.com/boltdb/bolt">bolt</a>，这个项目目前的状态已经是归档不再维护，如果想要使用这个项目可以使用 CoreOS 的 <a href="https://github.com/etcd-io/bbolt">bbolt</a> 版本。</p>
<p>Raft：Raft 强一致性算法的具体实现，是 <code>etcd</code> 的核心。</p>
<p>WAL：Write Ahead Log（预写式日志），是 <code>etcd</code> 的数据持久化存储方式。除了在内存中存有所有数据的状态以及节点的索引以外，<code>etcd</code> 就通过 WAL 进行持久化存储。WAL 中，所有的数据提交前都会事先记录日志。snapshot 是为了防止数据过多而进行快照压缩，默认每 10000 条记录做一次 <code>snapshot</code>, 经过 <code>snapshot</code> 以后的 WAL 文件就可以删除了。而通过 API 可以查询的历史 <code>etcd</code> 操作默认为 1000 条(v2 版本，v3 版本只要还未被压缩均能查到)；Entry 表示存储的具体日志内容</p>
<p>通常，一个用户的请求发送过来，会经由 Server 转发给 Store 进行具体的事务处理，如果涉及到节点的修改，则交给 Raft 模块进行状态变更、日志记录，然后再同步给其他的 <code>etcd</code> 节点以确认数据提交，最后进行数据的提交，再次同步。</p>
<h3 id="2数据一致性">2、数据一致性<a href="#2数据一致性" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p><code>etcd</code> 集群是一个分布式系统，由多个节点相互通信构成整体对外服务，每个节点都存储了完整的数据，并且通过 Raft 协议保证每个节点维护的数据是一致的。在集群中的数据流向只有一个方向，即从 <code>Leader</code> （主节点）流向 <code>Follower</code>（从节点），当从节点收到写请求后均会自动转发到主节点，从节点甚至不需要知道谁是主节点，并由主节点执行写操作，然后追加日志同步到集群所有节点，也就是说所有 <code>Follower</code> 的数据必须与 <code>Leader</code> 保持一致，如果不一致则会被覆盖。从用户的角度来说，对 <code>etcd</code> 集群中的所有节点进行读写效果是一样的。</p>
<p>既然写操作涉及到节点间的数据同步，那么到底如何界定一个写入操作是成功的？<code>etcd</code> 认为写入请求被 <code>Leader</code> 节点处理并分发给了<code>Quorum(N/2+1)</code>个节点后，就是一个成功的写入。</p>
<p>为了保证数据的一致性，那么无论何时集群中必须有且只有一个有效的 <code>Leader</code>, 所以 <code>etcd</code> 通过 Raft 协议来选举 <code>Leader</code>。首先，需要明确的是在选举过程中会出现三种角色，它们的关系如下图，其中 <code>Candidate</code> 是在选举期间才会出现的角色，正常的 <code>etcd</code> 集群只有 <code>Leader</code> 和 <code>Folower</code>。</p>
<p><img src="https://i.loli.net/2021/03/22/VuDn3ceI4k1lpEm.png" alt="https//ilolinet/2021/03/22/VuDn3ceI4k1lpEmpng"></p>
<p><strong>大致选举流程：</strong></p>
<ol>
<li>集群初始化时，所有节点都处于 <code>Follower</code> 状态，当 <code>Follower</code> 一段时间 (<code>选举计时器</code>超时) 收不到 <code>Leader</code> 的心跳消息，就认为 <code>Leader</code>出现故障导致其任期 (<code>Term</code>) 过期，<code>Follower</code> 会转成 <code>Candidate</code>；</li>
<li><code>Candidate</code> 等<code>选举计时器</code>超时后，会先投自己一票，并向集群中其他节点发起选举请求，并带上自己的 Term ID 以及当前日志的 Max Index（确保新选举的 <code>Leader</code> 有最全的日志）;</li>
<li>如果其他节点在 Term ID 内还没有投票，就会比较 <code>Candidate</code> 的 Max Index 是否比自己小，如果比自己大或者相等，就会投票给 <code>Candidate</code>；同时，会将自己的<code>选举计时器</code>重置；</li>
<li><code>Candidate</code> 在获取到超过半数节点的选票后，升级为 <code>Leader</code>；并按照<code>心跳计时器</code>向集群中其他节点发送心跳报文，并同步日志等；<code>Follower</code> 收到心跳报文后，会重置<code>选举计时器</code>。</li>
</ol>
<h3 id="3数据模型">3、数据模型<a href="#3数据模型" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p><code>ectd</code> 提供了一个持久化、多版本、并发控制的数据模型，当键值对的值需要被新的数据替代时，<code>etcd</code> 还会继续保存先前版本的键值对。键值存储事实上是不可变的；它的操作不会就地更新结构，取而代之的是生成一个新的更新后的结构。在修改之后，<code>key</code> 的所有先前版本还是可以访问和监控的。为了防止维护老版本导致数据存储无限增长，存储应该被压缩来移除旧的版本，一旦存储被压缩来恢复空间，在压缩修订版本之前的修订版本都会被移除，即不可访问和监控。</p>
<p>在物理视图上，<code>etcd</code> 以 <a href="https://en.wikipedia.org/wiki/B%2B_tree">B+ 树</a> 键值对的方式来存储物理数据，为了追求效率，存储的是当前修订版本与上一个修订版本间的差异（增量），单个修订版本的数据可能对应到 B+ 树上的多个键。需要说明的是，B+ 树上存储的键是一个三元组 <code>revision</code> (<code>major</code>, <code>sub</code>, <code>type</code>)，<code>major</code> 是持有 <code>key</code> 的存储修订版本、<code>sub</code> 区分同一个修订版本的不同 <code>key</code>、<code>type</code> 是用于特殊值的可选后缀。B+ 树的 key 空间的字符串按 <strong>字典序</strong> 排序，所以可以高效的支持 <strong>范围查询</strong>。</p>
<p>除了使用 B+ 树 这种数据结构来持久化数据之外，<code>etcd</code> 还通过在内存中维护一棵 B 树索引来加速键的范围查询，<code>key</code> 是存储暴露给用户的 <code>key</code>。值是到持久化 B+ 树修改的指针。</p>
<h3 id="4修订版本">4、修订版本<a href="#4修订版本" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<ul>
<li><code>Revision</code> 表示改动序号（ID），每次 KV 的变化，leader 节点都会修改 <code>Revision</code> 值，因此，这个值在 <code>cluster</code> 内是全局唯一的，而且是递增的</li>
<li><code>ModRevison</code> 记录了某个 <code>key</code> 最近修改时的 Revision，即它是与 <code>key</code> 关联的</li>
<li><code>CreateRevision</code> 与<code>ModRevison</code>类似、记录的是某个<code>key</code>创建时的 <code>Revision</code></li>
<li><code>Version</code> 表示 KV 的版本号，初始值为 <code>1</code>，每次修改 KV 对应的 <code>Version</code> 都会加 <code>1</code>，也就是说它是作用在 KV 之内的， 与其他 KV 无关</li>
</ul>
<h3 id="5etcd-v3-的-mvcc-实现">5、Etcd v3 的 MVCC 实现<a href="#5etcd-v3-的-mvcc-实现" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p><code>etcd</code> 在 BoltDB 中存储的 key 是 <code>revision</code>，<code>value</code> 是 <code>etcd</code> 自己的 <code>key-value</code> 组合，也就是说 <code>etcd</code> 会在 BoltDB 中保存每个版本，从而实现多版本控制。</p>
<p>所以 <code>etcd</code> 在BoltDB 中查询数据时必须通过 <code>revision</code>，而客户端是通过 <code>key</code> 来查询 <code>value</code> 的，因此 <code>etcd</code> 还在内存中维护了一个 <code>kvindex</code>，用于保存 <code>key</code> 与 <code>revision</code> 之间的映射关系，也就是前文提到的 B 树索引。这样查询路径就变为：客户端提供 <code>key</code> =&gt; <code>etcd</code> 通过 <code>key</code> 在 <code>kvindex</code> 中查到对应的 <code>revision</code> =&gt; 接着通过 <code>revision</code> 在 BoltDB 查询 <code>value</code> =&gt; 最后将 <code>value</code> 返回给客户端</p>
<p>在内存的索引中，每个用户的原始 <code>key</code>都关联了一个 <code>keyIndex</code> 结构， 如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">keyIndex</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// 用户的原始 key
</span><span class="c1"></span>    <span class="nx">key</span>          <span class="p">[]</span><span class="kt">byte</span>
    <span class="c1">// 最近一次修改时 key 对应的 revision
</span><span class="c1"></span>    <span class="nx">modified</span>     <span class="nx">revison</span>
    <span class="c1">// key 的生命周期，第一次创建的 key 是 generations[0], 标记为删除后再次创建则为 generations[1]
</span><span class="c1"></span>    <span class="nx">generations</span>  <span class="p">[]</span><span class="nx">generation</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">generation</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// key 的版本，每次创建都是从零开始，之后每次更新都自增
</span><span class="c1"></span>    <span class="nx">ver</span>       <span class="kt">int64</span>
    <span class="c1">// key 创建时的 revision
</span><span class="c1"></span>    <span class="nx">created</span>   <span class="nx">revision</span>
    <span class="c1">// 用于记录每次更新时的 key 对应的 revision
</span><span class="c1"></span>    <span class="nx">revs</span>      <span class="p">[]</span><span class="nx">revision</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">revision</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// 唯一事务ID, 全局递增且不重复，一个事务里可以对多个 key 进行更新操作，但每个 key 最多只能更新一次
</span><span class="c1"></span>    <span class="nx">main</span> <span class="kt">int64</span>
    <span class="c1">// 标记有更新操作的 key，在每个事务内都是从零开始递增编号
</span><span class="c1"></span>    <span class="nx">sub</span>  <span class="kt">int64</span>
<span class="p">}</span>
</code></pre></div><p>综上，内存 B 树维护的是 <code>key</code> 到 <code>keyIndex</code> 之间的映射关系（<code>kvindex</code>），<code>keyIndex</code>内维护的是一个 <code>key</code> 对应多个版本的 <code>revision</code> 信息，而通过 <code>revision</code> 就可以在 BoltDB 中查询到对应的 <code>value</code>了。</p>
<h2 id="三etcdctl-基本操作">三、etcdctl 基本操作<a href="#三etcdctl-基本操作" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="1查看版本">1、查看版本<a href="#1查看版本" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">etcdctl version
</code></pre></div><h3 id="2写入">2、写入<a href="#2写入" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">etcdctl put &lt;key&gt; &lt;value&gt;
</code></pre></div><h3 id="3读取">3、读取<a href="#3读取" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<pre><code>// 读取键和值
etcdctl get &lt;key&gt;
// 只读取键
etcdctl get &lt;key&gt; --keys-only
// 读取某些前缀的键
etcdctl get &lt;key&gt; --prefix --keys-only
// 只读取值
etcdctl get &lt;key&gt; --print-value-only
// 读取某个范围的值
etcdctl get &lt;key1&gt; &lt;key2&gt;
// 读取 /test 为前缀的 key， 并限制数量为 3
etcdctl get /test --prefix --limit=3
// 因为 etcd 集群上键值存储的每个修改都会增加 etcd 集群的全局修订版本，应用可以通过提供旧有的 etcd 修改版本来读取被替代的键。
// 读取历史版本: 修订版本号为 vision=230
etcdctl get &lt;key&gt; --rev=230 --prefix
// 读取大于等于键 /test/key 的 byte 值的键
etcdctl get --from-key /test/key
// 以json格式输出
etcdctl get &lt;key&gt; --prefix --write-out=json
// 输出详细的信息
etcdctl get &lt;key&gt; --prefix --write-out=fields
</code></pre><h3 id="4删除">4、删除<a href="#4删除" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">// 删除一个键值对
etcdctl del &lt;key&gt;
// 删除键 &lt;key&gt; 并返回删除数以及被删除的键值对
etcdctl del --prev-kv &lt;key&gt;
// 删除 key1 到 key2 之间的键
etcdctl del &lt;key1&gt; &lt;key2&gt;
// 删除 /test 前缀的 key
etcdctl del /test --prefix
// 删除大于等于键 /test/key 的 byte 值的键
etcdctl del --from-key /test/key
</code></pre></div><h3 id="5监控-watch">5、监控 watch<a href="#5监控-watch" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">// 监控 &lt;key&gt; 的变化
etcdctl watch &lt;key&gt;
// 监控 &lt;key1&gt; 到 &lt;key2&gt; 范围的键
etcdctl watch &lt;key1&gt; &lt;key2&gt;
// 监控以 /test 为前缀的key
etcdctl watch /test --prefix
// 监控多个键
etcdctl watch -i
etcdctl watch &lt;key1&gt;
etcdctl watch &lt;key2&gt;
// 监控 key 的历史变动, 从 vision 为 <span class="m">3</span> 开始
etcdctl watch --rev<span class="o">=</span><span class="m">3</span> &lt;key&gt;
</code></pre></div><h3 id="6压缩修订版本">6、压缩修订版本<a href="#6压缩修订版本" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">// 被压缩的历史版本不能被查询
etcdctl compact &lt;vision&gt;

eg
$ etcdctl compact <span class="m">250</span>
compacted revision <span class="m">250</span>

$ etcdctl get /test --prefix --rev<span class="o">=</span><span class="m">249</span>
...mvcc: required revision has been compacted
</code></pre></div><h3 id="7授予租约">7、授予租约<a href="#7授予租约" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>应用可以为 <code>etcd</code> 集群里面的键授予租约。当键被附加到租约时，它的存活时间被绑定到租约的存活时间，而租约的存活时间相应的被 <code>time-to-live</code> (TTL) 管理。在租约授予时每个租约的最小 TTL 值由应用指定。租约的实际 TTL 值是不低于最小 TTL，由 <code>etcd</code> 集群选择。一旦租约的 TTL 到期，租约就过期并且所有附带的键都将被删除。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">// 授予租约， TTL 为 10s
$ etcdctl lease grant <span class="m">10</span>
lease 694d77e7d63d678f granted with TTL<span class="o">(</span>10s<span class="o">)</span>
// 将租约绑定到键上
etcdctl put --lease<span class="o">=</span>694d77e7d63d678f &lt;key&gt; &lt;value&gt;
</code></pre></div><h3 id="8撤销租约">8、撤销租约<a href="#8撤销租约" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>应用通过租约 id 可以撤销租约， 撤销租约将删除所有它附带的 key。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">etcdctl lease revoke 694d77e7d63d678f
</code></pre></div><h3 id="9维持租约">9、维持租约<a href="#9维持租约" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>租约到期时、会自动续约，此命令会阻塞命令行</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">etcdctl lease keep-alive 694d77e7d63d678f
</code></pre></div><h3 id="10获取租约信息">10、获取租约信息<a href="#10获取租约信息" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">// 返回租约时间以及剩余时间
$ etcdctl lease timetolive 694d77e7d63d67a4
lease 694d77e7d63d67a4 granted with TTL<span class="o">(</span>30s<span class="o">)</span>, remaining<span class="o">(</span>27s<span class="o">)</span>
// 返回租约时间以、剩余时间以及租约附带的key
$ etcdctl lease timetolive --keys 694d77e7d63d67a4
lease 694d77e7d63d67a4 granted with TTL<span class="o">(</span>30s<span class="o">)</span>, remaining<span class="o">(</span>28s<span class="o">)</span>, attached keys<span class="o">([</span>/test/bbb /test/aaa<span class="o">])</span>
</code></pre></div><h2 id="四golang-客户端简单示例">四、golang 客户端简单示例<a href="#四golang-客户端简单示例" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<blockquote>
<p>使用官方的 etcd/clientv3 包来连接 etcd 并进行相关操作</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">etcd</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;github.com/coreos/etcd/clientv3&#34;</span>
    <span class="s">&#34;github.com/coreos/etcd/clientv3/concurrency&#34;</span>
    <span class="s">&#34;log&#34;</span>
    <span class="s">&#34;os&#34;</span>
    <span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
        <span class="nx">Endpoints</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;127.0.0.1:2379&#34;</span><span class="p">},</span>
        <span class="nx">DialTimeout</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;init client fail&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;connect success, %s&#34;</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Username</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">GetClient</span><span class="p">()</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">client</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Put</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;put to etcd failed, err:%v\\\\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="c1">// 使用租约
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">PutWithLease</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ttl</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">LeaseID</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">grant</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Grant</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ttl</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;PutWithLease to etcd failed, err:%v\\\\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">WithLease</span><span class="p">(</span><span class="nx">grant</span><span class="p">.</span><span class="nx">ID</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;PutWithLease to etcd failed, err:%v\\\\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">grant</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Del</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;del to etcd failed, err:%v\\\\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;get from etcd failed, err:%v\\\\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#34;&#34;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Kvs</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;index: %d, keyValue: %s&#34;</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">string</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Kvs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Value</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 获取以key为前缀的kv
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">GetWithPrefix</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="p">[]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">get</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">WithPrefix</span><span class="p">())</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;GetWithPrefix from etcd failed, err:%v\\\\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">resp</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">get</span><span class="p">.</span><span class="nx">Kvs</span> <span class="p">{</span>
        <span class="c1">//log.Printf(&#34;index: %d, keyValue: %s&#34;, k, v)
</span><span class="c1"></span>        <span class="nx">m</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
        <span class="nx">m</span><span class="p">[</span><span class="nb">string</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">Key</span><span class="p">)]</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span>
        <span class="nx">resp</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">resp</span>
<span class="p">}</span>

<span class="c1">// 监控机制
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">watch</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">WithPrefix</span><span class="p">())</span>
    <span class="k">for</span> <span class="nx">w</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">watch</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ev</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Events</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;watch type: %s, k: %s, v: %s\\\\n&#34;</span><span class="p">,</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Kv</span><span class="p">.</span><span class="nx">Key</span><span class="p">),</span> <span class="nb">string</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Kv</span><span class="p">.</span><span class="nx">Value</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Clear</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">WithPrefix</span><span class="p">())</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;clear etcd fail, %v\\\\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="五基于-etcd-的分布式锁实践">五、基于 Etcd 的分布式锁实践<a href="#五基于-etcd-的分布式锁实践" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<blockquote>
<p>基于 etcd 客户端实现分布式锁，etcd 实现分布式锁的基础是 Lease (租约) 机制、Revision（修订版本号） 机制、Prefix 机制、Watch 机制</p>
<ul>
<li>Lease 机制：即租约机制（TTL，Time To Live），etcd 可以为存储的 key-value 对设置租约，当租约到期，key-value 将失效删除；同时也支持续约续期（KeepAlive）</li>
<li>Revision 机制：每个 <code>key</code> 带有一个 <code>Revision</code> 属性值，Etcd 每进行一次事务对应的全局 <code>Revision</code> 值都会加一，因此每个 Key 对应的 <code>Revision</code> 属性值都是全局唯一的。通过比较 <code>Revision</code> 的大小就可以知道进行写操作的顺序。在实现分布式锁时，多个程序同时抢锁，根据 <code>Revision</code> 值大小依次获得锁，可以避免惊群效应，实现公平锁</li>
<li>Prefix 机制：即前缀机制（或目录机制）。可以根据前缀（目录）获取该目录下所有的 Key 及对应的属性（包括 Key、Value 以及 <code>Revision</code> 等）</li>
<li>Watch 机制：即监听机制，Watch 机制支持 Watch 某个固定的 Key，也支持 Watch 一个目录前缀（前缀机制），当被 Watch 的 Key 或目录发生变化，客户端将收到通知</li>
</ul>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Lock</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 获取两个session模拟锁竞争
</span><span class="c1"></span>    <span class="nx">session1</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">NewSession</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;get session fail, %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">session2</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">NewSession</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;get session fail, %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">lock</span> <span class="o">:=</span> <span class="s">&#34;/test/lock&#34;</span>
    <span class="nx">locker1</span> <span class="o">:=</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">NewLocker</span><span class="p">(</span><span class="nx">session1</span><span class="p">,</span> <span class="nx">lock</span><span class="p">)</span>
    <span class="nx">locker2</span> <span class="o">:=</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">NewLocker</span><span class="p">(</span><span class="nx">session2</span><span class="p">,</span> <span class="nx">lock</span><span class="p">)</span>

    <span class="nx">locker1</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;get lock for session1&#34;</span><span class="p">)</span>

    <span class="nx">locked</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">locked</span><span class="p">)</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;before locker2 lock&#34;</span><span class="p">)</span>
        <span class="c1">// 阻塞知道等待session1释放锁
</span><span class="c1"></span>        <span class="nx">locker2</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;after locker2 lock&#34;</span><span class="p">)</span>
    <span class="p">}()</span>

    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
    <span class="c1">// session1 释放锁
</span><span class="c1"></span>    <span class="nx">locker1</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;session1 unlocked&#34;</span><span class="p">)</span>

    <span class="o">&lt;-</span><span class="nx">locked</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;get lock for session2&#34;</span><span class="p">)</span>

    <span class="nx">locker2</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;session2 unlocked&#34;</span><span class="p">)</span>

<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">2021-03-23 21:40:10.184063 I <span class="p">|</span> connect success,
2021-03-23 21:40:10.302807 I <span class="p">|</span> watch type: PUT, k: /test/lock/694d785eff30693d, v:
2021-03-23 21:40:10.302807 I <span class="p">|</span> get lock <span class="k">for</span> session1
2021-03-23 21:40:10.302807 I <span class="p">|</span> before locker2 lock
2021-03-23 21:40:10.303807 I <span class="p">|</span> watch type: PUT, k: /test/lock/694d785eff30693f, v:
2021-03-23 21:40:11.304476 I <span class="p">|</span> session1 unlocked
2021-03-23 21:40:11.304476 I <span class="p">|</span> watch type: DELETE, k: /test/lock/694d785eff30693d, v:
2021-03-23 21:40:11.309478 I <span class="p">|</span> after locker2 lock
2021-03-23 21:40:11.309478 I <span class="p">|</span> get lock <span class="k">for</span> session2
2021-03-23 21:40:11.310478 I <span class="p">|</span> session2 unlocked
2021-03-23 21:40:11.310478 I <span class="p">|</span> watch type: DELETE, k: /test/lock/694d785eff30693f, v:
</code></pre></div><h2 id="六基于-etcd-的分布式系统主备选举实践">六、基于 Etcd 的分布式系统主备选举实践<a href="#六基于-etcd-的分布式系统主备选举实践" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>日常开发中，为了避免服务的单点故障，我们通常会采用分布式架构的形式，但在某些场景下我们希望某些功能只由特定的节点执行，这些功同时能被多个节点同时执行的话可能导致数据不一致，所以我们的系统可以通过选举出 <code>leader</code> 的方式来避免这些问题，而基于 <code>Ralf</code> 协议的 <code>etcd</code> 就是一个实现分布式系统选举可靠的中间件，与实现分布式锁类似，实现选举也要依赖于 <code>lease</code> (租约) 机制、<code>revision</code>（修订版本号） 机制、<code>prefix</code> 机制、<code>watch</code> 机制</p>
<p><code>concurrency</code> 包实现选举的方法主要如下：</p>
<p><img src="https://i.loli.net/2021/03/25/G8Scuy7LINbxq5m.png" alt="https//ilolinet/2021/03/25/G8Scuy7LINbxq5mpng"></p>
<p>示例中主要会使用的方法是 concurrency.NewElection, concurrency.Election.Campaign, concurrency.Election.Resign</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Campaign</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="c1">// 为client创建session，并绑定租约，租约的ttl为5s, 如传入的ttl&lt;0, 将使用默认的ttl（60s）
</span><span class="c1"></span>        <span class="nx">session</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">NewSession</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">WithTTL</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">continue</span>
        <span class="p">}</span>

        <span class="c1">// campaignPrefix 是需要监听的目录前缀，发起选举会自动在末尾补 `/`
</span><span class="c1"></span>        <span class="nx">campaignPrefix</span> <span class="o">:=</span> <span class="s">&#34;/test/campaign&#34;</span>
        <span class="nx">election</span> <span class="o">:=</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">NewElection</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">campaignPrefix</span><span class="p">)</span>
        <span class="nx">hostname</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Hostname</span><span class="p">()</span>
        <span class="nx">campaignId</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s-%d&#34;</span><span class="p">,</span> <span class="nx">hostname</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getpid</span><span class="p">())</span>
        <span class="c1">// 1、以 keyPrefix + leaseId 为 key, campaignId 为 value 创建键值对
</span><span class="c1"></span>        <span class="c1">// 2、一直阻塞除非成功选举为 Leader 或者 context 过期
</span><span class="c1"></span>        <span class="c1">// 3、成功选举为 Leader 的条件是当前 key 比 keyPrefix 目录下的其他 key 的 CreateRevision 小
</span><span class="c1"></span>        <span class="c1">// 4、每个 key 都监听（等待）比自己 CreateRevision 小但 CreateRevision 最大的 key 被删除
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">election</span><span class="p">.</span><span class="nf">Campaign</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">campaignId</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">select</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="k">default</span><span class="p">:</span>
            <span class="p">}</span>
            <span class="k">continue</span>
        <span class="p">}</span>

        <span class="nx">Leader</span> <span class="p">=</span> <span class="nx">campaignId</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;leader: %s\\\\n&#34;</span><span class="p">,</span> <span class="nx">Leader</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">LeaderShouldDo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nf">LeaderShouldDo</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">session</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
            <span class="c1">// 放弃 Leader 的身份，重新发起新一轮选举
</span><span class="c1"></span>            <span class="nx">election</span><span class="p">.</span><span class="nf">Resign</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
            <span class="nx">session</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">QuitLeader</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nf">QuitLeader</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s quit leader\\\\n&#34;</span><span class="p">,</span> <span class="nx">Leader</span><span class="p">)</span>
            <span class="nx">Leader</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
            <span class="k">continue</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
            <span class="nx">session</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">QuitLeader</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nf">QuitLeader</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s quit leader\\\\n&#34;</span><span class="p">,</span> <span class="nx">Leader</span><span class="p">)</span>
            <span class="nx">Leader</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>假设系统中有三个节点，如图，3 节点监听 2 节点，2 节点监听 1 节点，1 节点是 Leader</p>
<p>1）假如 2 节点租约过期了，那么 3 节点将监听 1 节点</p>
<p>2） 假如 1 节点的租约过期了，那么 2 节点成为 Leader</p>
<p><img src="https://i.loli.net/2021/03/25/GfwiCYLs3xZgXDz.png" alt="https//ilolinet/2021/03/25/GfwiCYLs3xZgXDzpng"></p>
<p><strong>启动三个 client后依次停止client1、client2、client3</strong></p>
<p><strong>client1</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">2021-03-25 15:30:44.036311 I <span class="p">|</span> connect success,
2021-03-25 15:30:44.140412 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fd87, v: chenhongbin-25712
2021-03-25 15:30:44.148287 I <span class="p">|</span> leader: chenhongbin-25712
2021-03-25 15:30:50.267831 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fd8b, v: chenhongbin-27112
2021-03-25 15:30:55.430359 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fd8f, v: chenhongbin-24684
2021-03-25 15:31:15.770408 I <span class="p">|</span> chenhongbin-25712 quit leader
2021-03-25 15:31:15.770913 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd87, v:
</code></pre></div><p><strong>client2</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">2021-03-25 15:30:50.171378 I <span class="p">|</span> connect success,
2021-03-25 15:30:50.268338 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fd8b, v: chenhongbin-27112
2021-03-25 15:30:55.430359 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fd8f, v: chenhongbin-24684
2021-03-25 15:31:15.770408 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd87, v:
2021-03-25 15:31:15.775075 I <span class="p">|</span> leader: chenhongbin-27112
2021-03-25 15:31:18.673096 I <span class="p">|</span> chenhongbin-27112 quit leader
2021-03-25 15:31:18.673096 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd8b, v:
</code></pre></div><p><strong>client3</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">2021-03-25 15:30:55.373742 I <span class="p">|</span> connect success,
2021-03-25 15:30:55.430359 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fd8f, v: chenhongbin-24684
2021-03-25 15:31:15.770408 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd87, v:
2021-03-25 15:31:18.673096 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd8b, v:
2021-03-25 15:31:18.678095 I <span class="p">|</span> leader: chenhongbin-24684
2021-03-25 15:31:32.872987 I <span class="p">|</span> chenhongbin-24684 quit leader
2021-03-25 15:31:32.872987 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd8f, v:
</code></pre></div><p><strong>启动三个 client后依次停止 etcd 服务模拟网络异常，等待租约过期重新启动服务</strong></p>
<p><strong>client1</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">2021-03-25 15:34:10.450527 I <span class="p">|</span> connect success,
2021-03-25 15:34:10.547423 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fd98, v: chenhongbin-24980
2021-03-25 15:34:10.549421 I <span class="p">|</span> leader: chenhongbin-24980
2021-03-25 15:34:14.898319 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fd9c, v: chenhongbin-21324
2021-03-25 15:34:20.017620 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fda0, v: chenhongbin-13260
2021-03-25 15:34:54.375748 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd98, v:
2021-03-25 15:34:54.377772 I <span class="p">|</span> chenhongbin-24980 quit leader
2021-03-25 15:34:54.379744 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d78684eb7fb06, v: chenhongbin-24980
2021-03-25 15:34:54.530581 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd9c, v:
2021-03-25 15:34:54.547818 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fda0, v:
2021-03-25 15:34:54.559815 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d78684eb7fb0f, v: chenhongbin-21324
2021-03-25 15:34:54.559815 I <span class="p">|</span> leader: chenhongbin-24980
2021-03-25 15:34:54.562814 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d78684eb7fb14, v: chenhongbin-13260
</code></pre></div><p><strong>client2</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">2021-03-25 15:34:14.798817 I <span class="p">|</span> connect success,
2021-03-25 15:34:14.898319 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fd9c, v: chenhongbin-21324
2021-03-25 15:34:20.017620 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fda0, v: chenhongbin-13260
2021-03-25 15:34:54.381756 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd98, v:
2021-03-25 15:34:54.381756 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d78684eb7fb06, v: chenhongbin-24980
2021-03-25 15:34:54.483051 I <span class="p">|</span> leader: chenhongbin-21324
2021-03-25 15:34:54.534824 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd9c, v:
2021-03-25 15:34:54.544816 I <span class="p">|</span> chenhongbin-21324 quit leader
2021-03-25 15:34:54.547818 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fda0, v:
2021-03-25 15:34:54.559815 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d78684eb7fb0f, v: chenhongbin-21324
2021-03-25 15:34:54.562814 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d78684eb7fb14, v: chenhongbin-13260
</code></pre></div><p><strong>client3</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">2021-03-25 15:34:19.897700 I <span class="p">|</span> connect success,
2021-03-25 15:34:20.017620 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d786823c4fda0, v: chenhongbin-13260
2021-03-25 15:34:54.375748 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd98, v:
2021-03-25 15:34:54.380743 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d78684eb7fb06, v: chenhong
bin-24980
2021-03-25 15:34:54.530581 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fd9c, v:
2021-03-25 15:34:54.543815 I <span class="p">|</span> leader: chenhongbin-13260
2021-03-25 15:34:54.547818 I <span class="p">|</span> watch type: DELETE, k: /test/campaign/694d786823c4fda0, v:
2021-03-25 15:34:54.559815 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d78684eb7fb0f, v: chenhongbin-21324
2021-03-25 15:34:54.559815 I <span class="p">|</span> chenhongbin-13260 quit leader
2021-03-25 15:34:54.562814 I <span class="p">|</span> watch type: PUT, k: /test/campaign/694d78684eb7fb14, v: chenhongbin-13260
</code></pre></div><h2 id="七基于-etcd-服务发现实践">七、基于 Etcd 服务发现实践<a href="#七基于-etcd-服务发现实践" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>所谓服务发现就是了解集群中是否有进程在监听 UDP 或者 TCP 端口，并且通过名字就可以进行查找和链接，因为在微服务中，一个服务重启后其 <code>endpoint</code> 极有可能发生变化</p>
<p>满足服务发现的条件：</p>
<ol>
<li>服务注册：强一致性、高可用的服务存储目录，基于 Raft 算法的 <code>etcd</code> 天生就是这样一个强一致性、高可用的服务存储目录，以此来实现服务注册</li>
<li>健康检查：租约机制可用来实现服务健康状况检测，定时续约以达到监控健康状态的效果</li>
<li>服务发现：watch 机制，可以及时发现注册服的更新、删除</li>
</ol>
<p><img src="https://i.loli.net/2021/06/04/EGBYDXaNt3ClzQ1.png" alt="https//ilolinet/2021/06/04/EGBYDXaNt3ClzQ1png"></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">etcd</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;github.com/coreos/etcd/clientv3&#34;</span>
    <span class="s">&#34;log&#34;</span>
    <span class="s">&#34;sync&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">DiscoveryRoot</span> <span class="p">=</span> <span class="s">&#34;/discovery&#34;</span>

<span class="kd">type</span> <span class="nx">serviceRegisterDiscovery</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">mux</span>              <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
    <span class="nx">ctx</span>              <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
    <span class="nx">leaseIdMap</span>       <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">LeaseID</span>
    <span class="nx">serviceName</span>      <span class="kt">string</span>
    <span class="nx">keepAliveChanMap</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">&lt;-</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">LeaseKeepAliveResponse</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewServiceRegisterDiscovery</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">serviceName</span> <span class="nx">str</span>    <span class="nx">ing</span><span class="p">)</span> <span class="o">*</span><span class="nx">serviceRegisterDiscovery</span> <span class="p">{</span>
    <span class="nx">leaseIdMap</span><span class="p">,</span> <span class="nx">keepAliveChanMap</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">LeaseID</span><span class="p">),</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">&lt;-</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">LeaseKeepAliveResponse</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">serviceRegisterDiscovery</span><span class="p">{</span>
        <span class="nx">leaseIdMap</span><span class="p">:</span>       <span class="nx">leaseIdMap</span><span class="p">,</span>
        <span class="nx">serviceName</span><span class="p">:</span>      <span class="nx">serviceName</span><span class="p">,</span>
        <span class="nx">keepAliveChanMap</span><span class="p">:</span> <span class="nx">keepAliveChanMap</span><span class="p">,</span>
        <span class="nx">ctx</span><span class="p">:</span>              <span class="nx">ctx</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">serviceRegisterDiscovery</span><span class="p">)</span> <span class="nf">key</span><span class="p">(</span><span class="nx">endpoint</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s/%s/%s&#34;</span><span class="p">,</span> <span class="nx">DiscoveryRoot</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">,</span> <span class="nx">endpoint</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">serviceRegisterDiscovery</span><span class="p">)</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">endpoint</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">lease</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">mux</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mux</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="nx">key</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">key</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">)</span>
    <span class="nx">leaseId</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">PutWithLease</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">endpoint</span><span class="p">,</span> <span class="nx">lease</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="c1">// 自动续约
</span><span class="c1"></span>    <span class="nx">keepAliveChan</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">KeepAlive</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">leaseId</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="nx">s</span><span class="p">.</span><span class="nx">leaseIdMap</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">s</span><span class="p">.</span><span class="nx">keepAliveChanMap</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">leaseId</span><span class="p">,</span> <span class="nx">keepAliveChan</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">serviceRegisterDiscovery</span><span class="p">)</span> <span class="nf">ListenLeaseChan</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">keepAliveChanMap</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">length</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">keepAliveChanMap</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">length</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
        <span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">ch</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">keepAliveChanMap</span> <span class="p">{</span>
            <span class="nx">i</span><span class="o">++</span>
            <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">for</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ch</span> <span class="p">{</span>
                    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="s">&#34;keepalive successful&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Revision</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}()</span>
            <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">length</span><span class="p">{</span>
                <span class="k">break</span>
            <span class="p">}</span>
            <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
        <span class="nx">length</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">keepAliveChanMap</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;all lease of %s is canceled&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">serviceRegisterDiscovery</span><span class="p">)</span> <span class="nf">CloseService</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">leasId</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leaseIdMap</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Revoke</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">leasId</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">leaseIdMap</span> <span class="p">=</span> <span class="kc">nil</span>
    <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">serviceRegisterDiscovery</span><span class="p">)</span> <span class="nf">CancelEndpoint</span><span class="p">(</span><span class="nx">endpoint</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">leaseId</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leaseIdMap</span><span class="p">[</span><span class="nx">s</span><span class="p">.</span><span class="nf">key</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">)]</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Revoke</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">leaseId</span><span class="p">)</span>
    <span class="nb">delete</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">leaseIdMap</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">key</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">))</span>
    <span class="nb">delete</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">keepAliveChanMap</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">key</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">serviceRegisterDiscovery</span><span class="p">)</span> <span class="nf">Discovery</span><span class="p">()</span> <span class="p">[]</span><span class="kt">string</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">services</span> <span class="p">[]</span><span class="kt">string</span>
    <span class="nx">prefix</span> <span class="o">:=</span> <span class="nf">GetWithPrefix</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">key</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">))</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">p</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">prefix</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span> <span class="p">{</span>
            <span class="nx">services</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">services</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">services</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">etcd</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;log&#34;</span>
    <span class="s">&#34;math/rand&#34;</span>
    <span class="s">&#34;testing&#34;</span>
    <span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestNewServiceRegisterDiscovery</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">svcRegisterDiscovery</span> <span class="o">:=</span> <span class="nf">NewServiceRegisterDiscovery</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;web&#34;</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nx">svcRegisterDiscovery</span><span class="p">.</span><span class="nf">CloseService</span><span class="p">()</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="nx">discovery</span> <span class="o">:=</span> <span class="nx">svcRegisterDiscovery</span><span class="p">.</span><span class="nf">Discovery</span><span class="p">()</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">discovery</span><span class="p">)</span>
            <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
            <span class="nx">endpoint</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;127.0.0.1:909%d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
            <span class="nx">err</span> <span class="o">:=</span> <span class="nx">svcRegisterDiscovery</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;err: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="mi">5</span> <span class="p">{</span>
                <span class="nx">delEndpoint</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;127.0.0.1:909%d&#34;</span><span class="p">,</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
                <span class="k">for</span> <span class="p">!</span><span class="nx">svcRegisterDiscovery</span><span class="p">.</span><span class="nf">CancelEndpoint</span><span class="p">(</span><span class="nx">delEndpoint</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">delEndpoint</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;127.0.0.1:909%d&#34;</span><span class="p">,</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="k">go</span> <span class="nx">svcRegisterDiscovery</span><span class="p">.</span><span class="nf">ListenLeaseChan</span><span class="p">()</span>
    <span class="k">select</span> <span class="p">{}</span>

<span class="p">}</span>
</code></pre></div><h2 id="八基于-etcd-的共享配置中心实践">八、基于 etcd 的共享配置中心实践<a href="#八基于-etcd-的共享配置中心实践" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>应用启动的时候拉取某个特定目录下的存储的配置信息，同时注册一个 watcher 并等待更新，etcd 会实时通知应用更新配置</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">etcd</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;encoding/json&#34;</span>
    <span class="s">&#34;flag&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;github.com/coreos/etcd/mvcc/mvccpb&#34;</span>
    <span class="s">&#34;log&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">config</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">server</span>
    <span class="nx">database</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">server</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Addr</span>  <span class="kt">string</span> <span class="s">`json:&#34;addr&#34;`</span>
    <span class="nx">Port</span>  <span class="kt">string</span> <span class="s">`json:&#34;port&#34;`</span>
    <span class="nx">Name</span>  <span class="kt">string</span> <span class="s">`json:&#34;app&#34;`</span>
    <span class="nx">Token</span> <span class="kt">string</span> <span class="s">`json:&#34;token&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">database</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Type</span>     <span class="kt">string</span> <span class="s">`json:&#34;type&#34;`</span>
    <span class="nx">Url</span>      <span class="kt">string</span> <span class="s">`json:&#34;url&#34;`</span>
    <span class="nx">User</span>     <span class="kt">string</span> <span class="s">`json:&#34;user&#34;`</span>
    <span class="nx">Password</span> <span class="kt">string</span> <span class="s">`json:&#34;password&#34;`</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="p">(</span>
    <span class="c1">// /config/appName/profile
</span><span class="c1"></span>    <span class="nx">configKeyFmt</span> <span class="p">=</span> <span class="s">&#34;/config/%s/%s&#34;</span>
    <span class="nx">Config</span>       <span class="nx">config</span>
    <span class="nx">Env</span>          <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;profile&#34;</span><span class="p">,</span> <span class="s">&#34;test&#34;</span><span class="p">,</span> <span class="s">&#34;use profile for config&#34;</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">configPath</span><span class="p">(</span><span class="nx">appName</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="nx">configKeyFmt</span><span class="p">,</span> <span class="nx">appName</span><span class="p">,</span> <span class="o">*</span><span class="nx">Env</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">InitConfig</span><span class="p">(</span><span class="nx">appName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">:=</span> <span class="nf">configPath</span><span class="p">(</span><span class="nx">appName</span><span class="p">)</span>
    <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;get config from etcd fail, err: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Kvs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Value</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">Config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;unmarshal config info fail, err: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;init config info success...&#34;</span><span class="p">)</span>

    <span class="k">go</span> <span class="nf">watchConfig</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">watchConfig</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">watch</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">path</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">w</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">watch</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;w: %v\\\\n&#34;</span><span class="p">,</span> <span class="nx">w</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Events</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">mvccpb</span><span class="p">.</span><span class="nx">PUT</span><span class="p">:</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Kv</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">Config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="nx">log</span><span class="p">.</span><span class="nf">Panicf</span><span class="p">(</span><span class="s">&#34;format err of %s, err: %v&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Kv</span><span class="p">.</span><span class="nx">Value</span><span class="p">),</span> <span class="nx">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;update config success...&#34;</span><span class="p">)</span>
            <span class="k">case</span> <span class="nx">mvccpb</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">:</span>
                <span class="nx">log</span><span class="p">.</span><span class="nf">Panicf</span><span class="p">(</span><span class="s">&#34;config info is deleted&#34;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">etcd</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;encoding/json&#34;</span>
    <span class="s">&#34;testing&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestInitConfig</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nf">Clear</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">{</span><span class="nx">server</span><span class="p">{</span>
        <span class="nx">Addr</span><span class="p">:</span>  <span class="s">&#34;0.0.0.0&#34;</span><span class="p">,</span>
        <span class="nx">Port</span><span class="p">:</span>  <span class="s">&#34;8080&#34;</span><span class="p">,</span>
        <span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;test&#34;</span><span class="p">,</span>
        <span class="nx">Token</span><span class="p">:</span> <span class="s">&#34;test&#34;</span><span class="p">,</span>
    <span class="p">},</span> <span class="nx">database</span><span class="p">{</span>
        <span class="nx">Type</span><span class="p">:</span>     <span class="s">&#34;mysql&#34;</span><span class="p">,</span>
        <span class="nx">Url</span><span class="p">:</span>      <span class="s">&#34;mysql://127.0.0.1:3306?test&#34;</span><span class="p">,</span>
        <span class="nx">User</span><span class="p">:</span>     <span class="s">&#34;root&#34;</span><span class="p">,</span>
        <span class="nx">Password</span><span class="p">:</span> <span class="s">&#34;123456&#34;</span><span class="p">,</span>
    <span class="p">}}</span>
    <span class="nx">marshal</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;err: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">appName</span> <span class="o">:=</span> <span class="s">&#34;test&#34;</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Put</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nf">configPath</span><span class="p">(</span><span class="nx">appName</span><span class="p">),</span> <span class="nb">string</span><span class="p">(</span><span class="nx">marshal</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;err: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nf">InitConfig</span><span class="p">(</span><span class="nx">appName</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Put</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nf">configPath</span><span class="p">(</span><span class="nx">appName</span><span class="p">),</span> <span class="nb">string</span><span class="p">(</span><span class="nx">marshal</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;err: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">select</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div><h2 id="九基于-etcd-的分布式通知与协调实践">九、基于 etcd 的分布式通知与协调实践<a href="#九基于-etcd-的分布式通知与协调实践" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="1-生命探针检测">1、 生命探针检测<a href="#1-生命探针检测" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>需要依赖 <code>etcd</code> 的 <code>watch</code>机制和 <code>lease</code>机制，检测系统和被检测系统通过在 <code>etcd</code> 上的某个目录进行关联，从而实现解耦</p>
<p><img src="https://i.loli.net/2021/06/04/xTAZ2OCutDdNYIv.png" alt="https//ilolinet/2021/06/04/xTAZ2OCutDdNYIvpng"></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">etcd</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;github.com/coreos/etcd/clientv3&#34;</span>
    <span class="s">&#34;log&#34;</span>
    <span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">pathTemplate</span> <span class="p">=</span> <span class="s">&#34;/test/probe/%s&#34;</span>

<span class="kd">type</span> <span class="nx">probe</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ctx</span>      <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
    <span class="nx">workName</span> <span class="kt">string</span>
    <span class="nx">ttl</span>      <span class="kt">int64</span>
    <span class="nx">leaseId</span>  <span class="nx">clientv3</span><span class="p">.</span><span class="nx">LeaseID</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewProbe</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ttl</span> <span class="kt">int64</span><span class="p">)</span> <span class="o">*</span><span class="nx">probe</span> <span class="p">{</span>
    <span class="nx">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">probe</span><span class="p">{</span>
        <span class="nx">ctx</span><span class="p">:</span>      <span class="nx">ctx</span><span class="p">,</span>
        <span class="nx">workName</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span>
        <span class="nx">ttl</span><span class="p">:</span>      <span class="nx">ttl</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nx">leaseId</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">PutWithLease</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nf">probePath</span><span class="p">(),</span> <span class="nx">p</span><span class="p">.</span><span class="nf">probePath</span><span class="p">(),</span> <span class="nx">ttl</span><span class="p">)</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">leaseId</span> <span class="p">=</span> <span class="nx">leaseId</span>
    <span class="k">return</span> <span class="nx">p</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">probe</span><span class="p">)</span> <span class="nf">probePath</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="nx">pathTemplate</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">workName</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">probe</span><span class="p">)</span> <span class="nf">postHealth</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">KeepAliveOnce</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">leaseId</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;keepalive fail, err: %v\\\\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">probe</span><span class="p">)</span> <span class="nf">watchLifeProbe</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nf">probePath</span><span class="p">())</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s is healthy\\\\n&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">workName</span><span class="p">)</span>
        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">.</span><span class="nf">Nanoseconds</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">ttl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="p">}</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s is unhealthy\\\\n&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">workName</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p><strong>测试代码</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">TestNewProbe</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">probe</span> <span class="o">:=</span> <span class="nf">NewProbe</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;test&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">go</span> <span class="nx">probe</span><span class="p">.</span><span class="nf">watchLifeProbe</span><span class="p">()</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">probe</span><span class="p">.</span><span class="nf">postHealth</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;post health fail, err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;post health success &#34;</span><span class="p">)</span>
            <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">select</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div><h3 id="2-完成系统调度">2、 完成系统调度<a href="#2-完成系统调度" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>依赖于 <code>watch</code> 机制，控制台负责特定目录的更新，推送系统监听目录的更新</p>
<p><img src="https://i.loli.net/2021/06/04/HsmdchwnMPGzZkq.png" alt="https//ilolinet/2021/06/04/HsmdchwnMPGzZkqpng"></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">etcd</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;github.com/coreos/etcd/mvcc/mvccpb&#34;</span>
    <span class="s">&#34;log&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">TaskState</span> <span class="kt">uint8</span>

<span class="kd">const</span> <span class="p">(</span>
    <span class="nx">Scheduled</span> <span class="nx">TaskState</span> <span class="p">=</span> <span class="kc">iota</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nx">Starting</span>
    <span class="nx">Running</span>
    <span class="nx">Finished</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">stateList</span> <span class="p">=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;Scheduled&#34;</span><span class="p">,</span> <span class="s">&#34;Starting&#34;</span><span class="p">,</span> <span class="s">&#34;Running&#34;</span><span class="p">,</span> <span class="s">&#34;Finished&#34;</span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="nx">TaskState</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">stateList</span><span class="p">[</span><span class="nx">t</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">ParseTaskState</span><span class="p">(</span><span class="nx">state</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">TaskState</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">stateList</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">s</span> <span class="o">==</span> <span class="nx">state</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">TaskState</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">taskScheduler</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ctx</span>   <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
    <span class="nx">Name</span>  <span class="kt">string</span>    <span class="s">`json:&#34;name&#34;`</span>
    <span class="nx">State</span> <span class="nx">TaskState</span> <span class="s">`json:&#34;state&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewTaskScheduler</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">taskName</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">taskScheduler</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">taskScheduler</span><span class="p">{</span>
        <span class="nx">ctx</span><span class="p">:</span>   <span class="nx">ctx</span><span class="p">,</span>
        <span class="nx">Name</span><span class="p">:</span>  <span class="nx">taskName</span><span class="p">,</span>
        <span class="nx">State</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">taskScheduler</span><span class="p">)</span> <span class="nf">Key</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;/scheduler/task/%s&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">taskScheduler</span><span class="p">)</span> <span class="nf">Notify</span><span class="p">(</span><span class="nx">state</span> <span class="nx">TaskState</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">state</span> <span class="p">&lt;</span> <span class="nx">Scheduled</span> <span class="o">||</span> <span class="nx">state</span> <span class="p">&gt;</span> <span class="nx">Finished</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error state: %d&#34;</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="nx">state</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;console notify task %s to work\\\\n&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">Put</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Key</span><span class="p">(),</span> <span class="nx">t</span><span class="p">.</span><span class="nx">State</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">taskScheduler</span><span class="p">)</span> <span class="nf">WatchNotify</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">watch</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Key</span><span class="p">())</span>
    <span class="k">for</span> <span class="nx">w</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">watch</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Events</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">mvccpb</span><span class="p">.</span><span class="nx">PUT</span><span class="p">:</span>
                <span class="nx">t</span><span class="p">.</span><span class="nf">Work</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Kv</span><span class="p">.</span><span class="nx">Value</span><span class="p">))</span>
            <span class="k">case</span> <span class="nx">mvccpb</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">:</span>
                <span class="nx">t</span><span class="p">.</span><span class="nb">close</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">taskScheduler</span><span class="p">)</span> <span class="nf">Work</span><span class="p">(</span><span class="nx">state</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="nf">ParseTaskState</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="k">switch</span> <span class="nx">state</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">Scheduled</span><span class="p">.</span><span class="nf">String</span><span class="p">():</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;task %s is scheduled\\\\n&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">Starting</span><span class="p">.</span><span class="nf">String</span><span class="p">():</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;task %s begin  working\\\\n&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">Running</span><span class="p">.</span><span class="nf">String</span><span class="p">():</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;task %s is running\\\\n&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">Finished</span><span class="p">.</span><span class="nf">String</span><span class="p">():</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;task %s finnish working\\\\n&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
        <span class="nf">Del</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Key</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">taskScheduler</span><span class="p">)</span> <span class="nb">close</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="mi">0</span>
<span class="p">}</span>
</code></pre></div><p>测试代码</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">etcd</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;testing&#34;</span>
    <span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestTaskScheduler</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
    <span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nf">Clear</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

    <span class="nx">scheduler</span> <span class="o">:=</span> <span class="nf">NewTaskScheduler</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;taskName&#34;</span><span class="p">)</span>
    <span class="k">go</span> <span class="nx">scheduler</span><span class="p">.</span><span class="nf">WatchNotify</span><span class="p">()</span>
    <span class="nx">scheduler</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">Scheduled</span><span class="p">)</span>
    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
    <span class="nx">scheduler</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">Starting</span><span class="p">)</span>
    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
    <span class="nx">scheduler</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">Running</span><span class="p">)</span>
    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
    <span class="nx">scheduler</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">Finished</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h3 id="3-完成工作汇报">3、 完成工作汇报<a href="#3-完成工作汇报" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>依赖于 <code>watch</code> 机制，启动子任务时建立一个临时目录，子任务可以通过更新这个临时目录的值来汇报自己的工作进度</p>
<p><img src="https://i.loli.net/2021/06/04/WOoDdEi3GRQsA2p.png" alt="https//ilolinet/2021/06/04/WOoDdEi3GRQsA2ppng"></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">etcd</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;github.com/coreos/etcd/mvcc/mvccpb&#34;</span>
    <span class="s">&#34;log&#34;</span>
    <span class="s">&#34;strconv&#34;</span>
    <span class="s">&#34;strings&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">workReporter</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ctx</span>      <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span> <span class="s">`json:&#34;ctx&#34;`</span>
    <span class="nx">Name</span>     <span class="kt">string</span>          <span class="s">`json:&#34;name&#34;`</span>
    <span class="nx">progress</span> <span class="kt">int</span>             <span class="s">`json:&#34;progress&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewWorkReporter</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">workReporter</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">workReporter</span><span class="p">{</span>
        <span class="nx">ctx</span><span class="p">:</span>      <span class="nx">ctx</span><span class="p">,</span>
        <span class="nx">Name</span><span class="p">:</span>     <span class="nx">name</span><span class="p">,</span>
        <span class="nx">progress</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">workReporter</span><span class="p">)</span> <span class="nf">Key</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;/work/%s&#34;</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">workReporter</span><span class="p">)</span> <span class="nf">FmtProgress</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">progress</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;%&#34;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">workReporter</span><span class="p">)</span> <span class="nf">ParseProgress</span><span class="p">(</span><span class="nx">progress</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">progress</span><span class="p">,</span> <span class="s">&#34;%&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;progress isn&#39;t end of %&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">parse</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">progress</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nx">progress</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="nx">parse</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">workReporter</span><span class="p">)</span> <span class="nf">Report</span><span class="p">(</span><span class="nx">progress</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">progress</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">progress</span> <span class="p">&gt;</span> <span class="mi">100</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;the progress of %s is error&#34;</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">w</span><span class="p">.</span><span class="nx">progress</span> <span class="p">=</span> <span class="nx">progress</span>
    <span class="k">return</span> <span class="nf">Put</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Key</span><span class="p">(),</span> <span class="nx">w</span><span class="p">.</span><span class="nf">FmtProgress</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">workReporter</span><span class="p">)</span> <span class="nf">WatchNotify</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">watchChan</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Key</span><span class="p">())</span>
    <span class="k">for</span> <span class="nx">watch</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">watchChan</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Events</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">mvccpb</span><span class="p">.</span><span class="nx">PUT</span><span class="p">:</span>
                <span class="nx">progress</span> <span class="o">:=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Kv</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span>
                <span class="nx">parseInt</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">ParseProgress</span><span class="p">(</span><span class="nx">progress</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;parseInt paogress of %s fail, progress: %s\\\\n&#34;</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">progress</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="p">}</span>
                <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;the paogress of %s is %s\\\\n&#34;</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">progress</span><span class="p">)</span>
                <span class="nx">w</span><span class="p">.</span><span class="nx">progress</span> <span class="p">=</span> <span class="nx">parseInt</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>测试代码</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">etcd</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;math/rand&#34;</span>
    <span class="s">&#34;testing&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestWorkReporter</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
    <span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nf">Clear</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
    <span class="nx">reporter</span> <span class="o">:=</span> <span class="nf">NewWorkReporter</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;workReporter&#34;</span><span class="p">)</span>
    <span class="k">go</span> <span class="nx">reporter</span><span class="p">.</span><span class="nf">WatchNotify</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="p">{</span>
        <span class="nx">i</span> <span class="o">+=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="mi">100</span> <span class="p">{</span>
            <span class="nx">i</span> <span class="p">=</span> <span class="mi">100</span>
        <span class="p">}</span>
        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">reporter</span><span class="p">.</span><span class="nf">Report</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;err: %v\\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
			</div>

			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://whocanfly.gitee.io/tags/%E4%BA%91%E5%8E%9F%E7%94%9F">云原生</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>7583 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2022-04-09 11:26 &#43;0800</p>
			</footer>
		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#一etcd-简介">一、Etcd 简介</a></li>
    <li><a href="#二etcd-工作原理">二、Etcd 工作原理</a>
      <ul>
        <li><a href="#1核心组件">1、核心组件</a></li>
        <li><a href="#2数据一致性">2、数据一致性</a></li>
        <li><a href="#3数据模型">3、数据模型</a></li>
        <li><a href="#4修订版本">4、修订版本</a></li>
        <li><a href="#5etcd-v3-的-mvcc-实现">5、Etcd v3 的 MVCC 实现</a></li>
      </ul>
    </li>
    <li><a href="#三etcdctl-基本操作">三、etcdctl 基本操作</a>
      <ul>
        <li><a href="#1查看版本">1、查看版本</a></li>
        <li><a href="#2写入">2、写入</a></li>
        <li><a href="#3读取">3、读取</a></li>
        <li><a href="#4删除">4、删除</a></li>
        <li><a href="#5监控-watch">5、监控 watch</a></li>
        <li><a href="#6压缩修订版本">6、压缩修订版本</a></li>
        <li><a href="#7授予租约">7、授予租约</a></li>
        <li><a href="#8撤销租约">8、撤销租约</a></li>
        <li><a href="#9维持租约">9、维持租约</a></li>
        <li><a href="#10获取租约信息">10、获取租约信息</a></li>
      </ul>
    </li>
    <li><a href="#四golang-客户端简单示例">四、golang 客户端简单示例</a></li>
    <li><a href="#五基于-etcd-的分布式锁实践">五、基于 Etcd 的分布式锁实践</a></li>
    <li><a href="#六基于-etcd-的分布式系统主备选举实践">六、基于 Etcd 的分布式系统主备选举实践</a></li>
    <li><a href="#七基于-etcd-服务发现实践">七、基于 Etcd 服务发现实践</a></li>
    <li><a href="#八基于-etcd-的共享配置中心实践">八、基于 etcd 的共享配置中心实践</a></li>
    <li><a href="#九基于-etcd-的分布式通知与协调实践">九、基于 etcd 的分布式通知与协调实践</a>
      <ul>
        <li><a href="#1-生命探针检测">1、 生命探针检测</a></li>
        <li><a href="#2-完成系统调度">2、 完成系统调度</a></li>
        <li><a href="#3-完成工作汇报">3、 完成工作汇报</a></li>
      </ul>
    </li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://whocanfly.gitee.io/posts/kubernetes%E5%88%9D%E6%8E%A2/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>Kubernetes初探</span>
			</a>
			<a class="prev-post" href="https://whocanfly.gitee.io/posts/zookeeper%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Zookeeper学习笔记</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2022 <a href="https://whocanfly.gitee.io"> 无意 </a> loading </p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://whocanfly.gitee.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://whocanfly.gitee.io/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js" integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin="anonymous"></script>
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-166045776-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
